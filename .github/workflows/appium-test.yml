# GitHub Actions workflow for Appium Android UI Automation Tests
# Trigger: Manual dispatch (workflow_dispatch)
# Environment: Ubuntu latest + Android Emulator (API 28)
name: Appium Android UI Test CI/CD

on:
  workflow_dispatch:
    inputs: {}
  push:
    branches: [main]

jobs:
  appium-and-test:
    name: Run Appium Android Tests
    runs-on: ubuntu-latest
    continue-on-error: false

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.9 Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install Python Dependencies
        run: |
          set -e
          echo "Upgrading pip and installing project dependencies..."
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install py>=1.11.0
          echo "Python dependencies installed successfully"

      - name: Install Appium & UIAutomator2 Driver
        run: |
          set -e
          echo "Installing Node.js and Appium 2.0.0..."
          sudo apt-get update && sudo apt-get install -y nodejs npm
          npm install -g appium@2.0.0
          echo "Installing UIAutomator2 driver..."
          appium driver install uiautomator2
          appium --version
          appium driver list --installed

      - name: Run Tests on Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          emulator-options: "-no-window -no-audio -gpu swiftshader_indirect -no-boot-anim -no-snapshot-save -cores 2 -memory 2048"
          emulator-boot-timeout: 900
          script: |
            #!/bin/sh
            set -e
            # Define core paths (simplified for sh compatibility)
            APK_PATH="$GITHUB_WORKSPACE/apps/ApiDemos-debug.apk"
            APPIUM_LOG="$GITHUB_WORKSPACE/appium.log"
            REPORT_DIR="$GITHUB_WORKSPACE/API_Demo_reports"
            LOG_DIR="$GITHUB_WORKSPACE/API_Demo_logs"
            SCREENSHOT_DIR="$GITHUB_WORKSPACE/API_Demo_screenshots"

            # Step 1: Validate APK existence
            echo "=== Checking Test APK Existence ==="
            echo "Target APK path: $APK_PATH"
            if [ ! -f "$APK_PATH" ]; then
              echo "ERROR: APK NOT FOUND at $APK_PATH"
              ls -la "$GITHUB_WORKSPACE/apps/"
              exit 1
            fi
            echo "APK found successfully"

            # Step 2: Start Appium Server (ps + grep instead of pgrep for sh compatibility)
            echo -e "\n=== Starting Appium Server ==="
            nohup appium --relaxed-security > "$APPIUM_LOG" 2>&1 &
            APPIUM_PID=$!
            echo "Appium server started with PID: $APPIUM_PID"
            sleep 5
            if ps -ef | grep -v grep | grep appium > /dev/null; then
              echo "Appium process is active"
            else
              echo "ERROR: Appium failed to start"
              cat "$APPIUM_LOG"
              exit 1
            fi

            # Step 3: Wait for Emulator readiness (while loop for sh compatibility)
            echo -e "\n=== Waiting for Emulator/Appium Ready ==="
            echo "Sleeping 140s for emulator boot & Appium initialization..."
            sleep 140
            echo -e "\n=== Connected Android Devices ==="
            adb devices
            adb wait-for-device
            i=1
            while [ $i -le 5 ]; do
              if adb shell getprop ro.build.version.release > /dev/null 2>&1; then
                break
              fi
              echo "Emulator not ready, retrying ($i/5)..."
              sleep 10
              i=$((i+1))
            done
            echo "Emulator is ready"

            # Step 4: Create output directories
            echo -e "\n=== Preparing Output Directories ==="
            mkdir -p "$REPORT_DIR" "$LOG_DIR" "$SCREENSHOT_DIR"
            echo "Output directories created"

            # Step 5: Execute test cases
            echo -e "\n=== Starting Test Execution ==="
            pytest tests/ -v -s --html="$REPORT_DIR/report.html" --self-contained-html
            TEST_EXIT_CODE=$?
            echo -e "\n=== Test Execution Complete ==="
            echo "Pytest exit code: $TEST_EXIT_CODE"

            # Step 6: Stop Appium Server (killall instead of pkill for sh compatibility)
            echo -e "\n=== Stopping Appium Server ==="
            if ps -ef | grep -v grep | grep appium > /dev/null; then
              killall appium > /dev/null 2>&1 || true
              echo "Appium server stopped successfully"
            else
              echo "Appium server already stopped"
            fi

            # Exit with test result code
            exit $TEST_EXIT_CODE

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appium-test-results-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/API_Demo_reports/**
            ${{ github.workspace }}/API_Demo_logs/**
            ${{ github.workspace }}/API_Demo_screenshots/**
            ${{ github.workspace }}/appium.log
          retention-days: 7
