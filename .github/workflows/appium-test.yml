# GitHub Actions workflow for Appium Android UI Automation Tests
# Trigger: Manual dispatch (workflow_dispatch)
# Environment: Ubuntu latest + Android Emulator (API 28)
# Core Steps: Code Checkout → Env Setup → Dep Install → Emulator Run → Test Execution → Artifact Upload
name: Appium Android UI Test CI/CD

# Trigger workflow manually (supports on-demand test execution)
on:
  workflow_dispatch:

# Define test job with Ubuntu latest runner
jobs:
  appium-android-test:
    name: Run Appium Android Tests
    runs-on: ubuntu-latest
    # Ensure job continues to upload artifacts even if steps fail
    continue-on-error: false

    steps:
      # Step 1: Checkout source code from repository
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Fetch only latest commit for speed

      # Step 2: Setup Python environment (match project's Python version)
      - name: Setup Python 3.9 Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"  # Cache pip dependencies for faster runs

      # Step 3: Install Python dependencies (including pytest and Appium client)
      - name: Install Python Dependencies
        run: |
          set -e
          echo "Upgrading pip and installing project dependencies..."
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install py>=1.11.0
          echo "Python dependencies installed successfully"

      # Step 4: Install Appium & UIAutomator2 driver (Android automation)
      - name: Install Appium & UIAutomator2 Driver
        run: |
          set -e
          echo "Installing Node.js and Appium 2.0.0..."
          sudo apt-get update && sudo apt-get install -y nodejs npm
          npm install -g appium@2.0.0
          echo "Installing UIAutomator2 driver..."
          appium driver install uiautomator2
          # Verify Appium installation
          appium --version
          appium driver list --installed

      # Step 5: Start Android Emulator and Run Appium Tests
      - name: Run Tests on Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          # Emulator options: Headless mode (no GUI) for CI environment
          emulator-options: "-no-window -no-audio -gpu swiftshader_indirect -no-boot-anim -no-snapshot-save -cores 2 -memory 2048"
          emulator-boot-timeout: 900  # Extend timeout to 15 mins for stable boot
          # Core test execution script (use set -e to fail fast on error)
          script: |
            set -e
            # Pre-check: Ensure test APK exists (fail fast if missing)
            APK_PATH="${GITHUB_WORKSPACE}/apps/ApiDemos-debug.apk"
            echo "Checking if test APK exists at: $APK_PATH"
            test -f "$APK_PATH" || { echo "ERROR: Test APK not found at $APK_PATH"; ls -la "${GITHUB_WORKSPACE}/apps/"; exit 1; }
            echo "APK found successfully: $APK_PATH"

            # Start Appium server in background (relaxed security for CI)
            echo "Starting Appium server in background..."
            nohup appium --relaxed-security > appium.log 2>&1 &
            APPIUM_PID=$!
            echo "Appium server started with PID: $APPIUM_PID"

            # Wait for emulator and Appium to stabilize (consolidated sleep)
            echo "Waiting 140 seconds for emulator/Appium to be ready..."
            sleep 140

            # Verify emulator is connected
            echo "Checking connected Android devices..."
            adb devices
            adb wait-for-device  # Ensure device is ready

            # Run pytest with HTML report (verbose mode for debugging)
            echo "Starting Appium test execution..."
            pytest tests/ -v -s --html="${GITHUB_WORKSPACE}/API_Demo_reports/report.html" --self-contained-html
            TEST_EXIT_CODE=$?

            # Stop Appium server after tests
            echo "Stopping Appium server (PID: $APPIUM_PID)..."
            if ps -p $APPIUM_PID > /dev/null; then
              kill $APPIUM_PID
              echo "Appium server stopped successfully"
            else
              echo "Appium server already stopped"
            fi

            # Exit with test result code
            exit $TEST_EXIT_CODE

      # Step 6: Upload Test Artifacts (reports/logs) - run even if tests fail
      - name: Upload Test Results (Reports & Logs)
        if: always()  # Execute regardless of previous step success/failure
        uses: actions/upload-artifact@v4
        with:
          name: appium-test-results-${{ github.run_id }}  # Unique name with run ID
          path: |
            ${{ github.workspace }}/API_Demo_reports/**
            ${{ github.workspace }}/API_Demo_logs/**
            ${{ github.workspace }}/API_Demo_screenshots/**
            ${{ github.workspace }}/appium.log
          retention-days: 7  # Retain artifacts for 7 days (cleanup)
