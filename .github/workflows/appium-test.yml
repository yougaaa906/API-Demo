name: Appium Test
on: [workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Deps
        run: |
          python -m pip install --upgrade pip
          # Install dependencies from requirements.txt first
          pip install -r requirements.txt
          # Install core dependencies as fallback
          pip install appium-python-client==3.2.0 pytest==7.4.0 pytest-html==3.1.1
          # Verify pytest and plugins installation
          pip list | grep pytest

      - name: Install Appium
        run: |
          npm install -g appium@2.0.0
          appium driver install uiautomator2
          appium -v

      - name: Run Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          emulator-options: "-no-window -no-audio -gpu swiftshader_indirect -no-boot-anim -no-snapshot-save -cores 2"
          # Emulator boot timeout (seconds)
          emulator-boot-timeout: 600
          script: |
            # Start Appium server in background
            appium --relaxed-security &
            sleep 20
            
            # Check emulator boot status in loop (max 24 times, 5s interval)
            for i in {1..24}; do if adb shell getprop sys.boot_completed | grep -q "1"; then echo "✅ Emulator is ready!"; break; fi; echo "⏳ Waiting for emulator... (Check $i)"; sleep 5; done
            
            sleep 20
            
            # Run test cases and generate HTML report
            pytest tests/ -v -s --html=reports/report.html --self-contained-html

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            reports/
            logs/
            screenshots/
